<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø£Ø¨Ùˆ Ø­Ø°ÙŠÙØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body { font-family: 'Cairo', sans-serif; }
    .glass { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); border-radius: 16px; }
    .sidebar { transition: all 0.3s; }
    .sidebar:hover { width: 250px; }
    .nav-link { transition: all 0.2s; }
    .nav-link:hover { background: rgba(0,128,158,0.2); border-radius: 12px; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex">

  <!-- Sidebar -->
  <aside class="sidebar bg-primary-dark text-white w-16 md:w-64 h-screen p-4 fixed">
    <div class="flex items-center space-x-3 space-x-reverse mb-8">
      <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">AH</div>
      <span class="font-bold hidden md:block">Ø£Ø¨Ùˆ Ø­Ø°ÙŠÙØ©</span>
    </div>
    <nav class="space-y-2">
      <a href="#dashboard" class="nav-link p-3 flex items-center space-x-3 space-x-reverse text-sm md:text-base"><span>ğŸ“Š</span> <span class="hidden md:block">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</span></a>
      <a href="#news" class="nav-link p-3 flex items-center space-x-3 space-x-reverse text-sm md:text-base"><span>ğŸ“°</span> <span class="hidden md:block">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span></a>
      <a href="#rates" class="nav-link p-3 flex items-center space-x-3 space-x-reverse text-sm md:text-base"><span>ğŸ’±</span> <span class="hidden md:block">Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù</span></a>
      <a href="#users" class="nav-link p-3 flex items-center space-x-3 space-x-reverse text-sm md:text-base"><span>ğŸ‘¥</span> <span class="hidden md:block">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span></a>
      <a href="#" onclick="logout()" class="nav-link p-3 flex items-center space-x-3 space-x-reverse text-sm md:text-base text-red-200"><span>ğŸšª</span> <span class="hidden md:block">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span></a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="mr-16 md:mr-64 p-6 w-full">
    <header class="bg-white glass p-4 rounded-xl shadow mb-6">
      <h1 class="text-2xl font-bold text-primary-dark" id="page-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h1>
      <p class="text-gray-600">Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ <span id="user-greeting">Ù…Ø´Ø±Ù</span> | Ø¯ÙˆØ±Ùƒ: <span id="user-role" class="text-primary-medium font-semibold"></span></p>
    </header>

    <!-- Dashboard -->
    <section id="dashboard-content">
      <div class="grid md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white glass p-6 rounded-xl text-center">
          <h3 class="text-lg font-bold">Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h3>
          <p class="text-3xl font-bold text-primary-medium" id="news-count">...</p>
        </div>
        <div class="bg-white glass p-6 rounded-xl text-center">
          <h3 class="text-lg font-bold">Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</h3>
          <p class="text-3xl font-bold text-primary-medium" id="rates-count">...</p>
        </div>
        <div class="bg-white glass p-6 rounded-xl text-center">
          <h3 class="text-lg font-bold">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
          <p class="text-3xl font-bold text-primary-medium" id="users-count">...</p>
        </div>
      </div>
    </section>

    <!-- News Management -->
    <section id="news-content" class="hidden">
      <button onclick="addNews()" class="bg-primary-medium text-white px-4 py-2 rounded-lg mb-4">+ Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</button>
      <div id="news-list" class="space-y-4">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </section>

    <!-- Rates Management -->
    <section id="rates-content" class="hidden">
      <h2 class="text-xl font-bold mb-4">ØªØ­Ø¯ÙŠØ« Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù</h2>
      <table class="w-full bg-white glass rounded-xl overflow-hidden">
        <thead class="bg-primary-dark text-white">
          <tr>
            <th class="py-3">Ø§Ù„Ø¹Ù…Ù„Ø©</th>
            <th class="py-3">Ø§Ù„Ø´Ø±Ø§Ø¡</th>
            <th class="py-3">Ø§Ù„Ø¨ÙŠØ¹</th>
            <th class="py-3">ØªØ­Ø¯ÙŠØ«</th>
          </tr>
        </thead>
        <tbody id="rates-body">...</tbody>
      </table>
    </section>

    <!-- Users Management -->
    <section id="users-content" class="hidden">
      <h2 class="text-xl font-bold mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
      <button onclick="addUser()" class="bg-primary-medium text-white px-4 py-2 rounded-lg mb-4">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
      <table class="w-full bg-white glass rounded-xl overflow-hidden">
        <thead class="bg-primary-dark text-white">
          <tr>
            <th class="py-3">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th class="py-3">Ø§Ù„Ø¯ÙˆØ±</th>
            <th class="py-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th class="py-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="users-body">...</tbody>
      </table>
    </section>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz51vcrAMkQqlEHl8v6DorggTEVrWzjsND2oSUvzPgBbtNMuEErUsgpLEK6EunMl1LfQg/exec";
    const token = localStorage.getItem('adminToken');
    const role = localStorage.getItem('adminRole');
    const user = localStorage.getItem('adminUser');

    if (!token) window.location.href = 'admin-login.html';

    document.getElementById('user-greeting').textContent = user || 'Ù…Ø¬Ù‡ÙˆÙ„';
    document.getElementById('user-role').textContent = role;

    function showSection(id) {
      document.querySelectorAll('section[id$="-content"]').forEach(s => s.classList.add('hidden'));
      document.getElementById(id + '-content').classList.remove('hidden');
      document.getElementById('page-title').textContent = document.querySelector(`[href="#${id}"]`).textContent.trim();
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'admin-login.html';
    }

    async function fetchData(action) {
      const res = await fetch(API_URL + "?action=" + action);
      return await res.json();
    }

    window.onload = async () => {
      applyPermissions();
      const news = await fetchData('getNews');
      const rates = await fetchData('getRates');
      const users = await fetchData('getAdmins');

      document.getElementById('news-count').textContent = news.news?.length || 0;
      document.getElementById('rates-count').textContent = rates.rates?.length || 0;
      document.getElementById('users-count').textContent = users.admins?.length || 0;

      const ratesBody = document.getElementById('rates-body');
      rates.rates?.forEach(r => {
        ratesBody.innerHTML += `
          <tr>
            <td class="py-3 text-center">${r.Currency}</td>
            <td class="py-3 text-center"><input value="${r.Buy_Sanaa}" class="w-20 text-center border rounded p-1"></td>
            <td class="py-3 text-center"><input value="${r.Sell_Sanaa}" class="w-20 text-center border rounded p-1"></td>
            <td class="py-3 text-center"><button class="bg-green-500 text-white px-2 py-1 rounded text-xs" onclick="updateRate('${r.Currency}', this)">Ø­ÙØ¸</button></td>
          </tr>
        `;
      });

      const usersBody = document.getElementById('users-body');
      users.admins?.forEach(u => {
        usersBody.innerHTML += `
          <tr>
            <td class="py-3">${u.Username}</td>
            <td class="py-3">${u.Role}</td>
            <td class="py-3">${u.Status}</td>
            <td class="py-3">
              <button class="bg-red-500 text-white px-2 py-1 rounded text-xs" onclick="deleteUser('${u.Username}')">Ø­Ø°Ù</button>
            </td>
          </tr>
        `;
      });
    };

    function applyPermissions() {
      const role = localStorage.getItem('adminRole');
      if (role !== "Super Admin") {
        document.querySelector('[href="#users"]').parentElement.style.display = "none";
      }
    }

    async function updateRate(currency, btn) {
      const row = btn.closest('tr');
      const buy = row.querySelector('input:nth-child(2)').value;
      const sell = row.querySelector('input:nth-child(3)').value;

      if (!buy || !sell) {
        alert('Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
        return;
      }

      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'updateRates',
          rates: [{ Currency: currency, Buy_Sanaa: buy, Sell_Sanaa: sell }],
          admin: localStorage.getItem('adminUser')
        })
      });

      const data = await res.json();
      if (data.success) {
        btn.textContent = "âœ“";
        btn.disabled = true;
        setTimeout(() => { btn.textContent = "Ø­ÙØ¸"; btn.disabled = false; }, 2000);
      } else {
        alert('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
      }
    }

    async function addNews() {
      const title = prompt("Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±:");
      if (!title) return;
      const content = prompt("Ù†Øµ Ø§Ù„Ø®Ø¨Ø±:");
      const category = prompt("Ø§Ù„ØªØµÙ†ÙŠÙ (ØªØ­Ø¯ÙŠØ«Ø§ØªØŒ Ø¹Ø±ÙˆØ¶ØŒ ØªÙ‚Ù†ÙŠØ©):");

      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'addNews',
          news: { Title: title, Content: content, Category: category, Status: "Published" },
          admin: user
        })
      });

      const data = await res.json();
      if (data.success) {
        alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­');
        location.reload();
      }
    }

    function addUser() {
      alert('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù…ØªØ§Ø­Ø© Ù„Ù€ Super Admin ÙÙ‚Ø·');
    }

    function deleteUser(username) {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ' + username + 'ØŸ')) {
        alert('ØªÙ… Ø§Ù„Ø­Ø°Ù (ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ§Ù…Ù„)');
      }
    }
  </script>
</body>
</html>
